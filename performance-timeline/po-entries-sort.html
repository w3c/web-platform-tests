<!DOCTYPE HTML>
<head>
<meta charset="utf-8">
<title>PerformanceObservers: getEntries* sort order</title>
<meta name="author" title="JosephPecoraro" href="mailto:joepeck@webkit.org">
<meta name="assert" content="PerformanceObserverEntryList entries are sorted correctly">
<link rel="help" href="https://w3c.github.io/performance-timeline/#filter-performance-entry-buffer-by-name-and-type">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="performanceobservers.js"></script>
</head>
<h1>PerformanceObservers: getEntries* sort order</h1>
<p>getEntries, getEntriesByType and getEntriesByName sort order</p>
<div id="log"></div>
<script>
  async_test(function (t) {
    var stored_entries = [];
    var stored_entries_by_type = [];
    var observer = new PerformanceObserver(
        t.step_func(function (entryList, obs) {

          stored_entries = entryList.getEntries();
          stored_entries_by_type = entryList.getEntriesByType("mark");
          stored_entries_by_name = entryList.getEntriesByName("name-repeat");
          var startTimeOfMark2 = entryList.getEntriesByName("mark2")[0].startTime;

          checkSorted(stored_entries);
          checkEntries(stored_entries, [
            {entryType: "measure", name: "measure1"},
            {entryType: "measure", name: "measure2"},
            {entryType: "measure", name: "measure3"},
            {entryType: "measure", name: "name-repeat"},
            {entryType: "mark", name: "mark1"},
            {entryType: "mark", name: "mark2"},
            {entryType: "measure", name: "measure-matching-mark2-1"},
            {entryType: "measure", name: "measure-matching-mark2-2"},
            {entryType: "mark", name: "name-repeat"},
            {entryType: "mark", name: "name-repeat"},
          ]);

          checkSorted(stored_entries_by_type);
          checkEntries(stored_entries_by_type, [
            {entryType: "mark", name: "mark1"},
            {entryType: "mark", name: "mark2"},
            {entryType: "mark", name: "name-repeat"},
            {entryType: "mark", name: "name-repeat"},
          ]);

          checkSorted(stored_entries_by_name);
          checkEntries(stored_entries_by_name, [
            {entryType: "measure", name: "name-repeat"},
            {entryType: "mark", name: "name-repeat"},
            {entryType: "mark", name: "name-repeat"},
          ]);

          observer.disconnect();
          t.done();
        })
      );

    observer.observe({entryTypes: ["mark", "measure"]});

    performance.mark("mark1");
    performance.measure("measure1");
    wait(); // Ensure mark1 !== mark2 startTime by making sure performance.now advances.
    performance.mark("mark2");
    performance.measure("measure2");
    performance.measure("measure-matching-mark2-1", "mark2");
    wait(); // Ensure mark2 !== mark3 startTime by making sure performance.now advances.
    performance.mark("name-repeat");
    performance.measure("measure3");
    performance.measure("measure-matching-mark2-2", "mark2");
    wait(); // Ensure name-repeat startTime will differ.
    performance.mark("name-repeat");
    wait(); // Ensure name-repeat startTime will differ.
    performance.measure("name-repeat");
  }, "getEntries, getEntriesByType, getEntriesByName sort order");
</script>
