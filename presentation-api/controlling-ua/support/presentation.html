<!DOCTYPE html>

<meta charset="utf-8">
<link rel="author" title="Intel" href="http://www.intel.com">
<link rel="author" title="He Yue" href="mailto:yue.he@intel.com">
<link rel="author" title="Tomoyuki Shimizu" href="https://github.com/tomoyukilabs/">
<link rel="help" href="http://w3c.github.io/presentation-api/#interface-presentationconnectionlist">
<script src="stash.js"></script>
<script>
  const message1 = '1st';
  const message2 = '2nd';
  const message3 = new Uint8Array([51, 114, 100]);      // "3rd"
  const message4 = new Uint8Array([52, 116, 104]);      // "4th"
  const message5 = new Uint8Array([108, 97, 115, 116]); // "last"

  // compare two ArrayBuffer or Uint8Array
  const compare = (a, b) => {
    const p = toUint8Array(a);
    const q = toUint8Array(b);
    return !!p && !!q && p.every((item, index) => { return item === q[index]; });
  };

  const addConnection = connection => {
    connection.onconnect = function() {
      let result = [], testCase;

      this.onmessage = event => {
        document.body.innerHTML += event.data + '<br>';
        // PresentationConnection_send-manual.html
        if (testCase === 'send') {
          if (typeof event.data === 'string') {
            result.push({ type: 'text', data: event.data });
          }
          // default value of connection.binaryType is "arraybuffer"
          else if(event.data instanceof ArrayBuffer) {
            result.push({ type: 'binary', data: event.data});
            if (compare(event.data, message5)) {
              window.uploadStash(JSON.stringify(result));
            }
          }
          else {
            result.push({ type: 'error' });
          }
        }
      };

      waitForStash().then(data => {
        testCase = data;

        // PresentationConnection_send-manual.html
        if (testCase === 'send') {
          uploadStash('ok');
        }
        // PresentationConnection_onmessage-manual.html
        else if (testCase === 'onmessage') {
          connection.send(message1);              // string
          connection.send(message2);              // string
          connection.send(new Blob([message3]));  // Blob
          connection.send(message4.buffer);       // ArrayBuffer
          connection.send(message5);              // ArrayBufferView
          waitForStash().then(data => {
            connection.send(message5);
          });
        }
      });
    };
  };

  navigator.presentation.receiver.connectionList
    .then(list => {
      list.onconnectionavailable = evt => {
        addConnection(evt.connection);
      };
      list.connections.map(connection => {
        addConnection(connection);
      });
    });
</script>
