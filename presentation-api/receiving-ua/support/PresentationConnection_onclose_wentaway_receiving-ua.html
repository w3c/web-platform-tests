<!DOCTYPE html>

<meta charset="utf-8">
<title>[Optional] Closing a PresentationConnection by discarding a presentation connection object</title>
<link rel="author" title="Tomoyuki Shimizu" href="https://github.com/tomoyukilabs">
<link rel="help" href="https://w3c.github.io/presentation-api/#closing-a-presentationconnection">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="../common.js"></script>
<script src="stash.js"></script>

<script>
  const stash = new Stash(stashIds.toReceiver, stashIds.toController);

  add_completion_callback((tests, status) => {
    const log = document.getElementById('log');
    stash.send(JSON.stringify({ type: 'result', tests: tests, status: status, log: log.innerHTML }));
  });

  promise_test(t => {
    // enable timeout again, cause no user action is needed from here.
    t.step_timeout(() => {
      t.force_timeout();
      t.done();
    }, 3000);

    return navigator.presentation.receiver.connectionList.then(list => {
      let connection = list.connections[0];
      assert_equals(list.connections.length, 1, 'A presentation connection list is populated with a first presentation connection.');

      // check a connection closed due to aborting the nested browsing context
      const watchNewConnection = new EventWatcher(t, list, 'connectionavailable');
      stash.send(JSON.stringify({ type: 'ok' }));
      return watchNewConnection.wait_for('connectionavailable').then(evt => {
        connection = evt.connection;
        stash.send(JSON.stringify({ type: 'ok' }));
        watchClose = new EventWatcher(t, connection, 'close');
        return watchClose.wait_for('close');
      }).then(evt => {
        assert_true(!!evt, 'A presentation connection is closed when its controller\'s browsing context is discarded.');
        assert_true(evt instanceof PresentationConnectionCloseEvent, 'An event using PresentationConnectionCloseEvent is fired.');
        assert_true(evt.isTrusted, 'The event is a trusted event.');
        assert_false(evt.bubbles, 'The event does not bubbles.');
        assert_false(evt.cancelable, 'The event is not cancelable.');
        assert_equals(evt.type, 'close', 'The event name is "close".');
        assert_equals(evt.target, connection, 'event.target is the presentation connection.');
        assert_equals(connection.state, 'closed', 'State of the presentation connection is "closed".');
        assert_equals(evt.reason, reason, 'The reason for closing the presentation connection is "wentaway".');
        assert_equals(evt.message, '', 'The message for closing the presentation connection is empty.');
      });
    });
  });
</script>
