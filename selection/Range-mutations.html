<!doctype html>
<title>Range mutation tests with selection</title>
<link rel="author" title="Aryeh Gregor" href=ayg@aryeh.name>
<meta name=timeout content=long>

<div id=log></div>
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<script src=../dom/common.js></script>
<script src=../dom/ranges/Range-mutations.js></script>
<script>
"use strict";

// This function is slightly scary, but it works well enough, so . . .
// sourceTests is an array of test data that will be altered in mysterious ways
// before being passed off to doTest, descFn is something that takes an element
// of sourceTests and produces the first part of a human-readable description
// of the test, testFn is the function that doTest will call to do the actual
// work and tell it what results to expect.
function doTests(sourceTests, descFn, testFn) {
  var tests = [];
  for (var i = 0; i < sourceTests.length; i++) {
    var params = sourceTests[i];
    var len = params.length;
    tests.push([
      descFn(params) + ", with selected " + describeRange(params[len - 4], params[len - 3], params[len - 2], params[len - 1]),
      function(params) { return function() {
        var evaledParams = params.map(eval);
        for (var i = 0; i < evaledParams.length; i++) {
          assert_true(typeof evaledParams[i] != "undefined",
            "Test bug: " + params[i] + " is undefined");
        }
        return testFn.apply(null, evaledParams);
      } }(params),
      true,
      params[len - 4],
      params[len - 3],
      params[len - 2],
      params[len - 1]
    ]);
  }
  generate_tests(doTest, tests);
}

// Finally run everything.  All grouped together at the end so that I can
// easily comment out some of them, so I don't have to wait for all test types
// to debug only some of them.
doTests(splitTextTests, function(params) { return params[0] + ".splitText(" + params[1] + ")" }, testSplitText);
doTests(insertDataTests, function(params) { return params[0] + ".insertData(" + params[1] + ", " + params[2] + ")" }, testInsertData);
doTests(appendDataTests, function(params) { return params[0] + ".appendData(" + params[1] + ")" }, testAppendData);
doTests(deleteDataTests, function(params) { return params[0] + ".deleteData(" + params[1] + ", " + params[2] + ")" }, testDeleteData);
doTests(replaceDataTests, function(params) { return params[0] + ".replaceData(" + params[1] + ", " + params[2] + ", " + params[3] + ")" }, testReplaceData);
doTests(dataChangeTests, function(params) { return params[0] + "." + eval(params[1]) + " " + eval(params[2]) + ' ' + params[3] }, testDataChange);
doTests(insertBeforeTests, function(params) { return params[0] + ".insertBefore(" + params[1] + ", " + params[2] + ")" }, testInsertBefore);
doTests(replaceChildTests, function(params) { return params[0] + ".replaceChild(" + params[1] + ", " + params[2] + ")" }, testReplaceChild);
doTests(appendChildTests, function(params) { return params[0] + ".appendChild(" + params[1] + ")" }, testAppendChild);
doTests(removeChildTests, function(params) { return params[0] + ".parentNode.removeChild(" + params[0] + ")" }, testRemoveChild);

testDiv.style.display = "none";
</script>
