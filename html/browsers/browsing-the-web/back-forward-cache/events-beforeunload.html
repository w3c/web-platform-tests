<!DOCTYPE HTML>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<script src="/html/cross-origin-embedder-policy/credentialless/resources/dispatcher.js"></script>
<script src="resources/helper.sub.js"></script>
<script>
// https://github.com/whatwg/html/pull/5889
promise_test(async t => {
  const idA = token();

  window.open(
    executorPath + idA + '&events=visibilitychange,pagehide,pageshow,load,beforeunload',
    '_blank', 'noopener');

  await send(idA, `
      prepareNavigation();
      location.href = '${originCrossSite + backPath}';
  `);

  await assert_bfcached(idA);

  assert_array_equals(
    await evalOn(idA, `getRecordedEvents()`),
    [
      'window.load',
      'window.pageshow',
      'window.beforeunload',
      'window.pagehide.persisted',
      'document.visibilitychange.hidden',
      'window.visibilitychange.hidden',
      'document.visibilitychange.visible',
      'window.visibilitychange.visible',
      'window.pageshow.persisted'
    ]);

}, 'Events fired (beforeunload handler is set but not unload)');
</script>
