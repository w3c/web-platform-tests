<!DOCTYPE html>
<meta charset="utf-8">
<title>Multi-globals: which one is the initiator?</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>

<body>
<script>
"use strict";
document.domain = "{{hosts[][]}}";

promise_test(async t => {
  const iframe = await insertIframe(t);
  const innerIframe =  iframe.contentDocument.querySelector("iframe");

  // In terms of https://github.com/whatwg/html/issues/6514,
  // - incumbentNavigationOrigin = this page's origin, https://{{hosts[][]}}:{{ports[https][0]}}
  // - source browsing context = iframe element's node document's BC so
  //   source BC's active document's origin = outer frame origin, https://{{hosts[][www]}}:{{ports[https][0]}}
  // - destination origin = https://{{hosts[][]}}:{{ports[https][0]}} (this page's origin)
  //
  // If the response's origin is constructed using incumbentNavigationOrigin, then the innermost iframe will be
  // same-origin. If it's constructed using the source browsing context's active document's origin, then it will be
  // cross-origin.
  innerIframe.src = "about:blank";

  await waitForLoad(innerIframe, "Failed to load the about:blank URL");

  // Test passes if this does not throw
  innerIframe.contentDocument.body;
}, "Using iframeEl.src");

promise_test(async t => {
  const iframe = await insertIframe(t);
  const innerIframe =  iframe.contentDocument.querySelector("iframe");

  // Here, https://html.spec.whatwg.org/#location-object-navigate sets the source browsing context to the
  // incumbent settings object's browsing context. So both incumbentNavigationOrigin and source BC's active document's
  // origin both = this page's origin, https://{{hosts[][]}}:{{ports[https][0]}}.
  //
  // So, the check will definitely pass.

  innerIframe.src = "about:blank";

  await waitForLoad(innerIframe, "Failed to load the about:blank URL");

  // Test passes if this does not throw
  innerIframe.contentDocument.body;
}, "Using location.href");

function insertIframe(t) {
  return new Promise((resolve, reject) => {
    const iframe = document.createElement("iframe");
    iframe.src = "https://{{hosts[][www]}}:{{ports[https][0]}}/html/browsers/browsing-the-web/navigating-across-documents/resources/multi-globals-subframe-1.sub.html";
    iframe.onload = () => resolve(iframe);
    iframe.onerror = () => reject(new Error("Failed to load the outer iframe"));

    t.add_cleanup(() => iframe.remove());

    document.body.append(iframe);
  });
}

function waitForLoad(iframe, errorMessage = "Failed to load iframe") {
  return new Promise((resolve, reject) => {
    iframe.onload = () => resolve(iframe);
    iframe.onerror = () => reject(new Error(errorMessage));
  });
}
</script>
