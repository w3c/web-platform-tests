<!DOCTYPE html>
<meta charset="utf-8">
<title>HTML: window.open `features`: non-integer values for feature `top`</title>
<link rel="help" href="https://html.spec.whatwg.org/multipage/#apis-for-creating-and-navigating-browsing-contexts-by-name">

<!-- user agents are not required to support open features other than `noopener`
     and on some platforms position and size features don't make sense -->
<meta name="flags" content="may" />

<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/PrefixedPostMessage.js"></script>
<script>
var windowURL = 'resources/message-opener.html';
var featuresPrefix = `width=401,height=204,left=0,`;

// https://html.spec.whatwg.org/multipage/infrastructure.html#rules-for-parsing-integers
var baselineTop, baselineLeft;

setup (() => {
  var prefixedMessage = new PrefixedMessageTest();
  var featureString = `${featuresPrefix}top=0`;
  prefixedMessage.onMessage((data, e) => {
    e.source.close();
    baselineLeft = data.left;
    baselineTop = data.top;
    runWindowTests();
  });
  var win = window.open(prefixedMessage.url(windowURL), '', featureString);
});

function runWindowTests () {
  // When code point in first position is not an ASCII digit, "+" or "-",
  // that's an error and the value becomes 0
  [ 'top=/104',
    'top=_104',
    'top=L104',
    'top=0x68'
  ].forEach(feature => {
    async_test(t => {
      var prefixedMessage = new PrefixedMessageTest();
      var featureString = `${featuresPrefix}${feature}`;
      prefixedMessage.onMessage(t.step_func_done((data, e) => {
        e.source.close();
        assert_equals(data.top, baselineTop, `"${feature} begins with an invalid character and should be ignored"`);
      }));
      var win = window.open(prefixedMessage.url(windowURL), '', featureString);
    }, `features "${feature}" should NOT set "top=104"`);
  });

  [ 'top=105.5',
    'top=105.32',
    'top=105LLl',
    'top=105^4',
    'top=105*3',
    'top=105/5',
    'top=105  '
  ].forEach(feature => {
    async_test(t => {
      var prefixedMessage = new PrefixedMessageTest();
      var featureString = `${featuresPrefix}${feature}`;
      prefixedMessage.onMessage(t.step_func_done((data, e) => {
        e.source.close();
        assert_equals(data.top, 105, `"${feature} value after first non-digit will be ignored"`);
      }));
      var win = window.open(prefixedMessage.url(windowURL), '', featureString);
    }, `features "${feature}" should set "top=105"`);
  });
}

</script>
