<!DOCTYPE html>
<meta charset="utf-8">
<title>&lt;a download&gt; triggered download in sandbox is allowed by allow-downloads.</title>
<link rel="help" href="https://html.spec.whatwg.org/multipage/#attr-iframe-sandbox">
<link rel="help" href="https://html.spec.whatwg.org/multipage/#the-iframe-element">
<script src="/common/utils.js"></script>
<script src="/resources/testharness.js"></script>
<script src='/resources/testharnessreport.js'></script>
<script src="support/iframe_sandbox_download_helper.js"></script>
<body>
<script>
"use strict";

['', 'target="_blank" ', 'target="_blank" rel="noopener" '].forEach(
  attributes =>
  async_test(t => {
    const ttoken = token();
    let iframe = document.createElement("iframe");
    iframe.srcdoc = '<a target="_blank">Download</a>';
    iframe.sandbox = "allow-same-origin allow-popups allow-downloads";
    iframe.onload = t.step_func(function () {
      iframe.contentWindow.addEventListener(
        "unload", t.unreached_func("Unexpected navigation."));
      let anchor = iframe.contentDocument.getElementsByTagName('a')[0];
      anchor.href = "support/download_stash.py?token=" + ttoken;
      anchor.click();
      AssertDownloadSuccess(t, ttoken, DownloadVerifyDelay());
    });

    document.body.appendChild(iframe);
  }, `<a ${attributes} download> triggered download in sandbox ` +
             `is allowed by allow-downloads.`));
</script>
</body>
