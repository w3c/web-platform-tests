<!DOCTYPE html>
<title>Remove the last element on the fullscreen element stack</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="../trusted-click.js"></script>
<div id="log"></div>
<div id="first">
    <div id="last"></div>
</div>
<script>
async_test(function(t)
{
    var first = document.getElementById("first");
    trusted_request(t, first);
    document.onfullscreenchange = t.step_func(function(event)
    {
        assert_equals(document.fullscreenElement, first);
        assert_equals(event.target, first);
        var last = document.getElementById("last");
        trusted_request(t, last);
        document.onfullscreenchange = t.step_func(function(event)
        {
            assert_equals(document.fullscreenElement, last);
            assert_equals(event.target, last);
            last.remove();
            // Because /last/ was removed from the top layer, only /first/
            // remains and it becomes the new fullscreen element synchronously.
            assert_equals(document.fullscreenElement, first);
            document.onfullscreenchange = t.step_func_done(function(event)
            {
                // When the asynchronous steps of "exit fullscreen" ran, only
                // /first/ was in the top layer, and thus we exited fully.
                assert_equals(document.fullscreenElement, null);
                assert_equals(event.target, first);
            });
        });
    });
});
</script>
