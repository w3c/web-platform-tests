<!DOCTYPE html>
<meta charset=utf-8>
<title>Subresource Integrity</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<div id="log"></div>

<script>
  var xorigin_anon = location.protocol
    + '//www1.' + location.hostname + ':' + location.port 
    + '/subresource-integrity/crossorigin-anon.js';

  var xorigin_creds = location.protocol
    + '//www1.' + location.hostname + ':' + location.port 
    + '/subresource-integrity/crossorigin-creds.js';
    
  var xorigin_ineligible = location.protocol
    + '//www1.' + location.hostname + ':' + location.port 
    + '/subresource-integrity/crossorigin-ineligible.js';
</script>

<!--
  TODO: how well can we test cache-poisoning?
-->

<script>

    var SRIScriptTest = function(pass, name, src, integrityValue, crossoriginValue) {
        this.pass = pass;
        this.name = name;
        this.src = src;
        this.integrityValue = integrityValue;
        this.crossoriginValue = crossoriginValue;
    }
    
    SRIScriptTest.prototype.execute = function() {
        var test = async_test(this.name);
        var e = document.createElement("script");
        e.src = this.src;
        e.setAttribute("integrity", this.integrityValue);
        if(this.crossoriginValue) {
            e.setAttribute("crossorigin", crossoriginValue);
        }
        if(this.pass) {
            e.addEventListener("load", function() {test.done()});
            e.addEventListener("error", function() {
                test.step(function(){ assert_unreached() })
            });
        } else {
           e.addEventListener("load", function() {
                test.step(function() { assert_unreached() })
            });
           e.addEventListener("error", function() {test.done()});
        }
        document.body.appendChild(e);
    };
    
    var t1 = new SRIScriptTest(
        false,
        "Same-origin script with incorrect hash.",
        "loads-scripts-with-non-matching-digest.js",
        "sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead"
    ).execute();

        
    var t1 = new SRIScriptTest(
        true,
        "Same-origin script with correct hash.",
        "loads-scripts-with-matching-digest.js",
        "sha256-EKclUXH9SRRUv3FmL7bIEV0z2s3EvzHFxzHKCnfHT/E="
    ).execute();
    
</script>

<!--
<script>
    var so_test = async_test("Same-origin script with matching hash.");
    var so = document.createElement("script");
    so.setAttribute("integrity", "sha256-EKclUXH9SRRUv3FmL7bIEV0z2s3EvzHFxzHKCnfHT/E=");
    so.src = "loads-scripts-with-matching-digest.js";
    so.addEventListener(
        "load",
        function() {
            so_test.done();
        }
    );
    so.addEventListener(
        "error",
        function() {
            so_test.step(function() {assert_unreached('Failed to load.')})
        }
    );
    document.body.appendChild(so);

    var sob_test = async_test("Same-origin script with broken hash.");
    var sob = document.createElement("script");
    sob.setAttribute("integrity", "sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead");
    sob.src = "loads-scripts-with-matching-digest.js";
    sob.addEventListener(
        "load",
        function() {
            sob_test.step(function() {assert_unreached('Loaded.')})
        }
    );
    sob.addEventListener(
        "error",
        function() {
            sob_test.done();
        }
    );
    document.body.appendChild(sob);

    var xa_test = async_test("Crossorigin anonymous script with matching hash.");
    var xa = document.createElement("script");
    xa.setAttribute("integrity", "sha256-r6KBpvzfcSLlbFZCj1OACLxTxVck2TOrBTEdUbwz1yU=");
    xa.setAttribute("crossorigin", "anonymous");
    xa.src = xorigin_anon;
    xa.addEventListener(
        "load",
        function() {
            xa_test.done();
        }
    );
    xa.addEventListener(
        "error",
        function() {
            xa_test.step(function() {assert_unreached('Failed to load.')})
        }
    );
    document.body.appendChild(xa);

    var xa2_test = async_test("Crossorigin script with matching hash, no crossorigin attribute.");
    var xa2 = document.createElement("script");
    xa2.setAttribute("integrity", "sha256-r6KBpvzfcSLlbFZCj1OACLxTxVck2TOrBTEdUbwz1yU=");
    xa2.src = xorigin_anon;
    xa2.addEventListener(
        "load",
        function() {
            xa2_test.step(function() {assert_unreached('Loaded ineligible resource (non-CORS mode).')})
        }
    );
    xa2.addEventListener(
        "error",
        function() {
            xa2_test.done();
        }
    );
    document.body.appendChild(xa2);

    var xab_test = async_test("Crossorigin anonymous script with broken hash.");
    var xab = document.createElement("script");
    xab.setAttribute("integrity", "sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead");
    xab.setAttribute("crossorigin", "anonymous");
    xab.src = xorigin_anon;
    xab.addEventListener(
        "load",
        function() {
            xab_test.step(function() {assert_unreached('Loaded.')})
        }
    );
    xab.addEventListener(
        "error",
        function() {
            xab_test.done();
        }
    );
    document.body.appendChild(xab);

    var xc_test = async_test("Crossorigin credentialed script with matching hash.");
    var xc = document.createElement("script");
    xc.setAttribute("integrity", "sha256-sPICZvGN2S+pTRZgiw3DWrhC6JLDlt2zRyGpwH7unU8=");
    xc.setAttribute("crossorigin", "use-credentials");
    xc.src = xorigin_creds;
    xc.addEventListener(
        "load",
        function() {
            xc_test.done();
        }
    );
    xc.addEventListener(
        "error",
        function() {
            xc_test.step(function() {assert_unreached('Failed to load.')})
        }
    );
    document.body.appendChild(xc);

    var xcb_test = async_test("Crossorigin credentialed script with broken hash.");
    var xcb = document.createElement("script");
    xcb.setAttribute("integrity", "sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead");
    xcb.setAttribute("crossorigin", "use-credentials");
    xcb.src = xorigin_creds;
    xcb.addEventListener(
        "load",
        function() {
            xcb_test.step(function() {assert_unreached('Loaded.')})
        }
    );
    xcb.addEventListener(
        "error",
        function() {
            xcb_test.done();
        }
    );
    document.body.appendChild(xcb);

    var xi_test = async_test("Crossorigin ineligible script with matching hash. (crossorigin=\"anonymous\")");
    var xi = document.createElement("script");
    xi.setAttribute("integrity", "sha256-sPICZvGN2S+pTRZgiw3DWrhC6JLDlt2zRyGpwH7unU8=");
    xi.setAttribute("crossorigin", "anonymous");
    xi.src = xorigin_ineligible;
    xi.addEventListener(
        "load",
        function() {
            xi_test.step(function() {assert_unreached('Loaded.')})
        }
    );
    xi.addEventListener(
        "error",
        function() {
            xi_test.done();
        }
    );
    document.body.appendChild(xi);
    
    var xi2_test = async_test("Crossorigin ineligible script with matching hash (no crossorigin attribute).");
    var xi2 = document.createElement("script");
    xi2.setAttribute("integrity", "sha256-sPICZvGN2S+pTRZgiw3DWrhC6JLDlt2zRyGpwH7unU8=");
    xi2.src = xorigin_ineligible;
    xi2.addEventListener(
        "load",
        function() {
            xi2_test.step(function() {assert_unreached('Loaded.')})
        }
    );
    xi2.addEventListener(
        "error",
        function() {
            xi2_test.done();
        }
    );
    document.body.appendChild(xi2);
    
    // TODO test without setting crossorigin attribute
</script>-->