<!DOCTYPE html>
<html>
<head>
<title>Custom Elements: CEReactions on DOMTokenList interface</title>
<meta name="author" title="Ryosuke Niwa" href="mailto:rniwa@webkit.org">
<meta name="assert" content="add, remove, toggle, replace, and the stringifier of DOMTokenList interface must have CEReactions">
<meta name="help" content="https://dom.spec.whatwg.org/#node">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="./resources/reactions.js"></script>
</head>
<body>
<div id="log"></div>
<script>

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.add('foo');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, null);
    assert_equals(logEntries.log().newValue, 'foo');
    assert_equals(logEntries.log().namespace, null);
}, 'add on DOMTokenList must enqueue a attributeChanged reaction when adding an attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.add('foo');
    assert_array_equals(element.log().types(), []);
}, 'add on DOMTokenList must not enqueue a attributeChanged reaction when adding an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.add('world');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello');
    assert_equals(logEntries.log().newValue, 'hello world');
    assert_equals(logEntries.log().namespace, null);
}, 'add on DOMTokenList must enqueue a attributeChanged reaction when adding a value to an existing attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.add('world');
    assert_array_equals(element.log().types(), []);
}, 'add on DOMTokenList must enqueue a attributeChanged reaction when adding a value to an existing unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.remove('world');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello world');
    assert_equals(logEntries.log().newValue, 'hello');
    assert_equals(logEntries.log().namespace, null);
}, 'remove on DOMTokenList must enqueue a attributeChanged reaction when removing a value from an attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.remove('foo');
    assert_array_equals(element.log().types(), []);
}, 'remove on DOMTokenList must not enqueue a attributeChanged reaction when removing a non-existent value from an attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.remove('world');
    assert_array_equals(element.log().types(), []);
}, 'remove on DOMTokenList not must enqueue a attributeChanged reaction when removing a value from an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.toggle('world');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello');
    assert_equals(logEntries.log().newValue, 'hello world');
    assert_equals(logEntries.log().namespace, null);
}, 'toggle on DOMTokenList must enqueue a attributeChanged reaction when adding a value to an attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.toggle('world');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello world');
    assert_equals(logEntries.log().newValue, 'hello');
    assert_equals(logEntries.log().namespace, null);
}, 'toggle on DOMTokenList must enqueue a attributeChanged reaction when removing a value from an attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.toggle('world');
    assert_array_equals(element.log().types(), []);
}, 'remove on DOMTokenList not must enqueue a attributeChanged reaction when removing a value from an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.replace('hello', 'world');
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello');
    assert_equals(logEntries.log().newValue, 'world');
    assert_equals(logEntries.log().namespace, null);
}, 'replace on DOMTokenList must enqueue a attributeChanged reaction when replacing a value in an attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello world');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList.replace('foo', 'bar');
    assert_array_equals(element.log().types(), []);
}, 'replace on DOMTokenList must not enqueue a attributeChanged reaction when the token to replace does not exist in the attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList.replace('hello', 'world');
    assert_array_equals(element.log().types(), []);
}, 'replace on DOMTokenList must not enqueue a attributeChanged reaction when replacing a value in an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList = 'hello';
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, null);
    assert_equals(logEntries.log().newValue, 'hello');
    assert_equals(logEntries.log().namespace, null);
}, 'the stringifier of DOMTokenList must enqueue a attributeChanged reaction when adding an observed attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList = 'hello';
    var logEntries = element.log();
    assert_array_equals(element.log().types(), []);
}, 'the stringifier of DOMTokenList must not enqueue a attributeChanged reaction when adding an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList = 'world';
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello');
    assert_equals(logEntries.log().newValue, 'world');
    assert_equals(logEntries.log().namespace, null);
}, 'the stringifier of DOMTokenList must enqueue a attributeChanged reaction when mutating the value of an observed attribute');

test(function () {
    var element = defineNewCustomElement([]);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed']);
    instance.classList = 'world';
    assert_array_equals(element.log().types(), []);
}, 'the stringifier of DOMTokenList must not enqueue a attributeChanged reaction when mutating the value of an unobserved attribute');

test(function () {
    var element = defineNewCustomElement(['class']);
    var instance = document.createElement(element.name);
    instance.setAttribute('class', 'hello');
    assert_array_equals(element.log().types(), ['constructed', 'attributeChanged']);
    instance.classList = 'hello';
    var logEntries = element.log();
    assert_array_equals(logEntries.types(), ['attributeChanged']);
    assert_equals(logEntries.log().name, 'class');
    assert_equals(logEntries.log().oldValue, 'hello');
    assert_equals(logEntries.log().newValue, 'hello');
    assert_equals(logEntries.log().namespace, null);
}, 'the stringifier of DOMTokenList must enqueue a attributeChanged reaction when the setter is called with the original value of the attribute');

</script>
</body>
</html>
